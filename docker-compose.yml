version: "3.8"

services:
  db:
    image: mysql
    restart: always
    env_file: ./.env
    environment:
      - MYSQL_ROOT_PASSWORD=$AUTH_PASSWORD
      - MYSQL_DATABASE=$AUTH_DATABASE
    ports:
      - $AUTH_PORT:$AUTH_PORT
    volumes:
      - database:/var/lib/mysql
  auth-service:
    build: "./auth-service"
    env_file: ./.env
    volumes:
      - ./auth-service/src:/app/src
    ports:
      - $PORT:$PORT
    depends_on:
      - db
  messages-service:
    build: "./messages-service"
    env_file: ./.env
    volumes:
      - ./messages-service/src:/app/src
    ports:
      - $MESSAGES_PORT:$MESSAGES_PORT
    depends_on:
      - messages-db
  java-db:
    image: mysql
    restart: always
    env_file: ./.env
    environment:
      - MYSQL_ROOT_PASSWORD=$JAVA_DB_PASSWORD
      - MYSQL_DATABASE=$JAVA_DATABASE
    ports:
      - $JAVA_DB_EXTERNAL_PORT:$JAVA_DB_INTERNAL_PORT
    volumes:
      - java-db:/var/lib/mysql
  messages-db:
    image: mongo
    restart: always
    environment:
      - MONGO_INITDB_ROOT_USERNAME=$MONGO_USER
      - MONGO_INITDB_ROOT_PASSWORD=$MONGO_PASSWORD
    ports:
      - $MONGO_PORT:$MONGO_PORT
    volumes:
      - messages-db:/data/db
volumes:
  database:
  java-db:
  messages-db:
